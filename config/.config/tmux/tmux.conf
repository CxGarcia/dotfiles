# ==========================================
# tmux Configuration with sesh + skim
# ==========================================

# Change prefix to Ctrl-a (easier to reach than Ctrl-b)
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# Enable mouse support (for clicks and scrolling)
set -g mouse on

# Start windows and panes at 1, not 0 (easier to reach on keyboard)
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# Increase scrollback buffer
set -g history-limit 10000

# Better colors (enable true color support)
set -g default-terminal "screen-256color"
set -ga terminal-overrides ",xterm-256color:Tc"

# Split panes using | and - (more intuitive than % and ")
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# Reload config with Ctrl-a r
bind r source-file ~/.config/tmux/tmux.conf \; display "Config reloaded!"

# Debug keybinding - Ctrl-a d to show what tmux sees
bind d run-shell "~/.config/tmux/debug-ctrl-a.sh"

# Switch panes with Alt-arrow (no prefix needed)
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# Vim-style pane navigation (Ctrl-h/j/k/l)
bind -n C-h select-pane -L
bind -n C-j select-pane -D
bind -n C-k select-pane -U
bind -n C-l select-pane -R

# Resize panes easily
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# ==========================================
# THE MAGIC: sesh fuzzy session switcher with FZF
# ==========================================
# Press Ctrl-a Ctrl-a to:
# - In nvim: send Ctrl-a (opens Telescope)
# - In fam-dashboard: send Ctrl-a (fam dashboard uses it)
# - Elsewhere: open sesh
bind-key "C-a" run-shell "\
  current_pane_program=$(tmux display-message -p '#{pane_current_command}'); \
  current_session=$(tmux display-message -p '#{session_name}'); \
  if [ \"$current_pane_program\" = \"nvim\" ] || [ \"$current_session\" = \"fam-dashboard\" ]; then \
    tmux send-keys 0x01; \
  else \
    sesh connect \"$( \
      sesh list -t | fzf-tmux -p 55%,60% \
        --no-sort --ansi \
        --border-label ' sesh ' \
        --prompt='ðŸªŸ  ' \
        --header='  ^x zoxide  ^d kill' \
        --bind 'tab:down,btab:up' \
        --bind 'ctrl-x:change-prompt(ðŸ“  )+reload(sesh list -z)' \
        --bind 'ctrl-d:execute(tmux kill-session -t {})+change-prompt(ðŸªŸ  )+reload(sesh list-t)' \
    )\"; \
  fi"

# Quick session creation from popup
bind-key C-p display-popup -E -w 80% -h 60% "\
  fd -H -t d -d 2 . ~/projects ~/dev ~ 2>/dev/null | \
  fzf --ansi --border=rounded --prompt='ðŸ“ Project: ' \
      --preview='eza --tree --color=always --level=2 {} 2>/dev/null || ls -la {}' | \
  xargs -I {} bash -c 'session=\$(basename {} | tr . _); \
    tmux new-session -d -s \$session -c {} 2>/dev/null || true; \
    tmux switch-client -t \$session'"

# Window navigation with Ctrl-a w (interactive picker)
bind-key w run-shell "tmux list-windows -F '#{window_index}: #{window_name}' | \
  fzf-tmux -p 55%,60% --border-label ' windows ' --prompt='ðŸªŸ  ' --reverse | \
  cut -d: -f1 | \
  xargs tmux select-window -t"

# Copy mode settings (vim-style)
setw -g mode-keys vi
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-selection-and-cancel

# Don't auto-rename windows
set -g allow-rename off

# Automatically set window title
set -g set-titles on
set -g set-titles-string '#S:#W'

# ==========================================
# Status Bar Configuration
# ==========================================
# Status bar (lualine-style, matches nvim rose-pine)
set -g status on
set -g status-position bottom
set -g status-style 'bg=#232C34'
set -g status-left-length 100
set -g status-right-length 100

# Left: session + path + zoom/prefix indicators
set -g status-left '#[fg=#191724,bg=#ebbcba,bold] #S #[fg=#ebbcba,bg=#2d3843]#[fg=#e0def4,bg=#2d3843]  #{b:pane_current_path} #{?window_zoomed_flag,#[fg=#f6c177] ,}#{?client_prefix,#[fg=#eb6f92] ,}#[fg=#2d3843,bg=#232C34]'

# Right: pane info + time + date
set -g status-right '#[fg=#2d3843,bg=#232C34]#[fg=#908caa,bg=#2d3843] #{pane_index}/#{window_panes} #[fg=#e0def4] %H:%M #[fg=#ebbcba,bg=#2d3843]#[fg=#191724,bg=#ebbcba,bold] %d/%m '

# Hide window list
set -g status-justify left
set -g window-status-format ''
set -g window-status-current-format ''
set -g window-status-separator ''

# Pane borders
set -g pane-border-style 'fg=#3a4450'
set -g pane-active-border-style 'fg=#908caa'

# No background difference between panes
set -g window-style 'bg=default'
set -g window-active-style 'bg=default'

# Message style (for commands like Ctrl-a :)
set -g message-style 'bg=#1e1e2e fg=#cdd6f4'

# Toggle status bar with Ctrl-a b (in case you want to see it temporarily)
bind-key b set-option status

# ==========================================
# Additional Quality-of-Life Settings
# ==========================================

# Faster escape time (better for vim)
set -sg escape-time 10

# Focus events enabled (for vim)
set -g focus-events on

# Increase repeat time for repeatable commands
set -g repeat-time 1000

# Activity monitoring
setw -g monitor-activity on
set -g visual-activity off

# Aggressive resize (useful when working with multiple screens)
setw -g aggressive-resize on
