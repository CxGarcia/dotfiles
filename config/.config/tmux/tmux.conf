# ==========================================
# tmux Configuration
# ==========================================

# Change prefix to Ctrl-a (easier to reach than Ctrl-b)
unbind C-b
set -g prefix C-a
# Send literal Ctrl-a to programs (e.g. readline beginning-of-line)
bind a send-prefix

# Use fish inside tmux (system login shell is zsh)
set -g default-shell /opt/homebrew/bin/fish

# Enable mouse support (for clicks and scrolling)
set -g mouse on

# Start windows and panes at 1, not 0 (easier to reach on keyboard)
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# Increase scrollback buffer
set -g history-limit 10000

# Better colors (enable true color support)
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-256color:Tc"
set -ga terminal-overrides ",xterm-ghostty:Tc"

# Undercurl support (colored curly underlines)
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

# Extended keys (kitty keyboard protocol for better key detection)
set -s extended-keys on
set -as terminal-features 'xterm-ghostty:extkeys'

# Split panes using | and - (more intuitive than % and ")
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# Reload config with Ctrl-a r
bind r source-file ~/.config/tmux/tmux.conf \; display "Config reloaded!"

# Switch panes with Alt-arrow (no prefix needed)
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# Vim-style pane navigation (Ctrl-h/j/k/l)
bind -n C-h select-pane -L
bind -n C-j select-pane -D
bind -n C-k select-pane -U
bind -n C-l select-pane -R

# Resize panes easily
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Session switcher (Ctrl-a Ctrl-a)
bind-key C-a display-popup -E -w 80% -h 70% -S 'fg=#3a4450' "bash ~/.config/tmux/scripts/ts.sh"

# Window switcher (Ctrl-a w)
bind-key w display-popup -E -w 80% -h 70% -S 'fg=#3a4450' "bash ~/.config/tmux/scripts/ts.sh --windows"

# System clipboard (all yanks go to macOS clipboard)
set -s copy-command 'pbcopy'

# Copy mode settings (vim-style)
setw -g mode-keys vi
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel
bind-key -T copy-mode-vi Y send-keys -X copy-line
bind-key -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel

# Incremental search (highlights as you type, like vim's incsearch)
bind-key -T copy-mode-vi / command-prompt -i -p "(search down)" "send -X search-forward-incremental \"%%%\""
bind-key -T copy-mode-vi ? command-prompt -i -p "(search up)" "send -X search-backward-incremental \"%%%\""

# Allow programs (like Claude Code) to set window/pane titles
set -g allow-rename on
setw -g automatic-rename on

# Pass terminal titles through to the terminal emulator
set -g set-titles on
set -g set-titles-string '#{pane_title}'

# ==========================================
# Status Bar Configuration
# ==========================================
# Status bar (lualine-style, matches nvim rose-pine)
set -g status-position bottom
set -g status-style 'bg=#232C34'
set -g status-left-length 100
set -g status-right-length 100

# Left: session + path + zoom/prefix indicators
set -g status-left '#[fg=#191724,bg=#ebbcba,bold] #S #[fg=#ebbcba,bg=#2d3843]#[fg=#e0def4,bg=#2d3843]  #{b:pane_current_path} #{?window_zoomed_flag,#[fg=#f6c177] ,}#{?client_prefix,#[fg=#eb6f92] ,}#[fg=#2d3843,bg=#232C34]'

# Right: pane info + time + date
set -g status-right '#[fg=#2d3843,bg=#232C34]#[fg=#908caa,bg=#2d3843] #{pane_index}/#{window_panes} #[fg=#e0def4] %H:%M #[fg=#ebbcba,bg=#2d3843]#[fg=#191724,bg=#ebbcba,bold] %d/%m '

# Window list (minimal, rose-pine themed)
set -g status-justify left
set -g window-status-format '#[fg=#908caa,bg=#232C34] #I:#W '
set -g window-status-current-format '#[fg=#191724,bg=#908caa,bold] #I:#W '
set -g window-status-separator ''

# Pane borders
set -g pane-border-style 'fg=#3a4450'
set -g pane-active-border-style 'fg=#908caa'

# Popup borders (match pane borders for session picker)
set -g popup-border-style 'fg=#3a4450'
set -g popup-border-lines rounded

# Message style (for commands like Ctrl-a :)
set -g message-style 'bg=#1e1e2e fg=#cdd6f4'

# Toggle status bar with Ctrl-a b (in case you want to see it temporarily)
bind-key b set-option status

# ==========================================
# Additional Quality-of-Life Settings
# ==========================================

# Faster escape time (better for vim)
set -sg escape-time 10

# Focus events enabled (for vim)
set -g focus-events on

# Increase repeat time for repeatable commands
set -g repeat-time 1000

# Activity monitoring
setw -g monitor-activity on
set -g visual-activity off

# Aggressive resize (useful when working with multiple screens)
setw -g aggressive-resize on

# Auto-create shared utility window (index 2) for git repos
set-hook -g after-new-session 'run-shell -b "bash ~/.config/tmux/scripts/util-window.sh \"#{session_name}\""'


# ==========================================
# Plugins (TPM)
# ==========================================

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'fcsonline/tmux-thumbs'
set -g @plugin 'laktak/extrakto'

# tmux-yank: stay in copy mode after yanking
set -g @yank_action 'copy-pipe'

# tmux-thumbs: hint-based copy (like vimium/flash.nvim)
set -g @thumbs-key F
set -g @thumbs-command 'echo -n {} | pbcopy'
set -g @thumbs-upcase-command 'echo -n {} | pbcopy'

# extrakto: fuzzy-find text in pane (like telescope grep)
set -g @extrakto_key 'Tab'
set -g @extrakto_copy_key 'y'
set -g @extrakto_insert_key 'Enter'
set -g @extrakto_clip_tool 'pbcopy'

# Initialize TPM (keep at very bottom)
run '~/.tmux/plugins/tpm/tpm'
