#!/usr/bin/env bash
# fleet-hook â€” Push events from fleet feature sessions to events.jsonl
# Configured as a global hook in ~/.claude/settings.json
# Filters to only fleet sessions (CWD under .claude/worktrees/)

INPUT=$(cat)
CWD=$(echo "$INPUT" | jq -r '.cwd // empty')
EVENT=$(echo "$INPUT" | jq -r '.hook_event_name // empty')

# Only process fleet sessions
echo "$CWD" | grep -q '\.claude/worktrees/' || exit 0

# Extract feature name from worktree path
FEATURE=$(echo "$CWD" | sed 's|.*\.claude/worktrees/||' | cut -d/ -f1)
[ -z "$FEATURE" ] && exit 0

EVENTS_FILE="$HOME/.claude/fleet/events.jsonl"
TS=$(date -u +%FT%TZ)

log_event() {
  echo "$1" >> "$EVENTS_FILE"
}

case "$EVENT" in
  Stop)
    log_event "{\"ts\":\"$TS\",\"feature\":\"$FEATURE\",\"event\":\"idle\"}"
    ;;
  PreCompact)
    log_event "{\"ts\":\"$TS\",\"feature\":\"$FEATURE\",\"event\":\"context_warning\"}"
    ;;
  Notification)
    TYPE=$(echo "$INPUT" | jq -r '.notification_type // empty')
    if [ "$TYPE" = "elicitation_dialog" ]; then
      log_event "{\"ts\":\"$TS\",\"feature\":\"$FEATURE\",\"event\":\"needs_input\"}"
    fi
    ;;
  PostToolUse)
    TOOL=$(echo "$INPUT" | jq -r '.tool_name // empty')
    [ "$TOOL" != "Bash" ] && exit 0

    COMMAND=$(echo "$INPUT" | jq -r '.tool_input.command // empty')
    RESPONSE=$(echo "$INPUT" | jq -r '.tool_response // empty')

    if echo "$COMMAND" | grep -q 'gh pr create'; then
      PR_URL=$(echo "$RESPONSE" | grep -oE 'https://github\.com/[^ ]+/pull/[0-9]+' | head -1)
      log_event "{\"ts\":\"$TS\",\"feature\":\"$FEATURE\",\"event\":\"pr_created\",\"url\":\"$PR_URL\"}"
    elif echo "$COMMAND" | grep -q 'git push'; then
      BRANCH=$(echo "$COMMAND" | grep -oE '[^ ]+$')
      log_event "{\"ts\":\"$TS\",\"feature\":\"$FEATURE\",\"event\":\"pushed\",\"branch\":\"$BRANCH\"}"
    fi
    ;;
esac

exit 0
