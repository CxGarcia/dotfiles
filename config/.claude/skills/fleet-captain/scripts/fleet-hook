#!/usr/bin/env bash
# fleet-hook â€” Push events from fleet feature sessions to events.jsonl
# Configured as a global hook in ~/.claude/settings.json
# Filters to only fleet sessions (CWD under .claude/worktrees/)

INPUT=$(cat)
CWD=$(echo "$INPUT" | jq -r '.cwd // empty')
EVENT=$(echo "$INPUT" | jq -r '.hook_event_name // empty')

# Only process fleet sessions
echo "$CWD" | grep -q '\.claude/worktrees/' || exit 0

# Extract feature name from worktree path
FEATURE=$(echo "$CWD" | sed 's|.*\.claude/worktrees/||' | cut -d/ -f1)
[ -z "$FEATURE" ] && exit 0

FLEET_DIR="$HOME/.claude/fleet"
EVENTS_FILE="$FLEET_DIR/events.jsonl"
STATE_FILE="$FLEET_DIR/.hook_state"
TS=$(date -u +%FT%TZ)

# Dedup: only log if this is a state change for this feature
last_event() {
  grep "^$FEATURE=" "$STATE_FILE" 2>/dev/null | cut -d= -f2
}

set_state() {
  local new_event="$1"
  touch "$STATE_FILE"
  sed -i '' "/^$FEATURE=/d" "$STATE_FILE" 2>/dev/null || true
  echo "$FEATURE=$new_event" >> "$STATE_FILE"
}

log_event() {
  echo "$1" >> "$EVENTS_FILE"
}

case "$EVENT" in
  Stop)
    # Only log idle transition, not every response
    if [ "$(last_event)" != "idle" ]; then
      set_state "idle"
      log_event "{\"ts\":\"$TS\",\"feature\":\"$FEATURE\",\"event\":\"idle\"}"
    fi
    ;;
  PreCompact)
    log_event "{\"ts\":\"$TS\",\"feature\":\"$FEATURE\",\"event\":\"context_warning\"}"
    ;;
  Notification)
    TYPE=$(echo "$INPUT" | jq -r '.notification_type // empty')
    if [ "$TYPE" = "elicitation_dialog" ]; then
      if [ "$(last_event)" != "needs_input" ]; then
        set_state "needs_input"
        log_event "{\"ts\":\"$TS\",\"feature\":\"$FEATURE\",\"event\":\"needs_input\"}"
      fi
    fi
    ;;
  PostToolUse)
    TOOL=$(echo "$INPUT" | jq -r '.tool_name // empty')
    [ "$TOOL" != "Bash" ] && exit 0

    # Any tool use means the session is working (reset idle state)
    set_state "working"

    COMMAND=$(echo "$INPUT" | jq -r '.tool_input.command // empty')
    RESPONSE=$(echo "$INPUT" | jq -r '.tool_response // empty')

    if echo "$COMMAND" | grep -q 'gh pr create'; then
      PR_URL=$(echo "$RESPONSE" | grep -oE 'https://github\.com/[^ ]+/pull/[0-9]+' | head -1)
      log_event "{\"ts\":\"$TS\",\"feature\":\"$FEATURE\",\"event\":\"pr_created\",\"url\":\"$PR_URL\"}"
    elif echo "$COMMAND" | grep -q 'git push'; then
      BRANCH=$(echo "$COMMAND" | grep -oE '[^ ]+$')
      log_event "{\"ts\":\"$TS\",\"feature\":\"$FEATURE\",\"event\":\"pushed\",\"branch\":\"$BRANCH\"}"
    fi
    ;;
esac

exit 0
