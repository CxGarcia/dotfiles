#!/usr/bin/env bash
# fleet-inject â€” Surface fleet events and state changes at the start of each turn.
# Runs as a UserPromptSubmit hook. Delegates to `fleet poll` for combined
# file-event + state-change detection.

FLEET_DIR="$HOME/.claude/fleet"
REGISTRY="$FLEET_DIR/registry.json"
FLEET_BIN="$HOME/.claude/skills/fleet-captain/scripts/fleet"

[ -f "$REGISTRY" ] || exit 0

HAS_ACTIVE=$(jq -e '[.features // {} | to_entries[] | select(.value.status != "done" and .value.status != "abandoned")] | length > 0' "$REGISTRY" 2>/dev/null)
[ "$HAS_ACTIVE" = "true" ] || exit 0

OUTPUT=$("$FLEET_BIN" poll 2>/dev/null)
[ -n "$OUTPUT" ] || exit 0

echo ""
echo "$OUTPUT"
echo ""
