#!/usr/bin/env bash
# fleet-inject — Surface fleet events and state changes at the start of each turn.
# Runs as a UserPromptSubmit hook. Delegates to `fleet poll` for combined
# file-event + state-change detection.

FLEET_DIR="$HOME/.claude/fleet"
REGISTRY="$FLEET_DIR/registry.json"
FLEET_BIN="$HOME/.claude/skills/fleet-captain/scripts/fleet"

[ -f "$REGISTRY" ] || exit 0

# Fast check: any feature not done/abandoned? (approximation — grep on raw JSON)
grep -q '"status"' "$REGISTRY" || exit 0
grep -qvE '"status"[[:space:]]*:[[:space:]]*"(done|abandoned)"' "$REGISTRY" || exit 0

OUTPUT=$("$FLEET_BIN" poll 2>/dev/null)
[ -n "$OUTPUT" ] || exit 0

echo ""
echo "$OUTPUT"
echo ""
