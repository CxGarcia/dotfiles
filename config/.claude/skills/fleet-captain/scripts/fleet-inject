#!/usr/bin/env bash
# fleet-inject — Inject discrete fleet events into captain context
# Runs on UserPromptSubmit. Reads new events from events.jsonl.

FLEET_DIR="$HOME/.claude/fleet"
EVENTS_FILE="$FLEET_DIR/events.jsonl"
OFFSET_FILE="$FLEET_DIR/.events_offset"
REGISTRY="$FLEET_DIR/registry.json"

[ -f "$REGISTRY" ] || exit 0
[ -f "$EVENTS_FILE" ] || exit 0

CURRENT_SIZE=$(wc -c < "$EVENTS_FILE" | tr -d ' ')
LAST_OFFSET=0
[ -f "$OFFSET_FILE" ] && LAST_OFFSET=$(cat "$OFFSET_FILE")

[ "$CURRENT_SIZE" -gt "$LAST_OFFSET" ] || exit 0

NEW_EVENTS=$(tail -c +"$((LAST_OFFSET + 1))" "$EVENTS_FILE")
echo "$CURRENT_SIZE" > "$OFFSET_FILE"

[ -n "$NEW_EVENTS" ] || exit 0

DEDUPED=$(echo "$NEW_EVENTS" | jq -s 'group_by(.feature + ":" + .event) | map(last) | sort_by(.ts)' 2>/dev/null)
[ -n "$DEDUPED" ] && [ "$DEDUPED" != "[]" ] || exit 0

FORMATTED=$(echo "$DEDUPED" | jq -r '.[] |
  if .event == "pr_created" then "  \(.feature): PR created \(.url // "")"
  elif .event == "pushed" then "  \(.feature): pushed \(.branch // "")"
  elif .event == "context_warning" then "  \(.feature): context compacting — may lose coherence"
  else "  \(.feature): \(.event)"
  end' 2>/dev/null)

[ -n "$FORMATTED" ] || exit 0

COUNT=$(echo "$FORMATTED" | wc -l | tr -d ' ')
echo ""
echo "--- Fleet Events ($COUNT new) ---"
echo "$FORMATTED"
echo "--- End Fleet Events ---"
echo ""
