#!/usr/bin/env bash

FLEET_DIR="$HOME/.claude/fleet"
EVENTS_FILE="$FLEET_DIR/events.jsonl"
OFFSET_FILE="$FLEET_DIR/.events_offset"

[ -f "$EVENTS_FILE" ] || exit 0

CURRENT_SIZE=$(wc -c < "$EVENTS_FILE" | tr -d ' ')
LAST_OFFSET=0
[ -f "$OFFSET_FILE" ] && LAST_OFFSET=$(cat "$OFFSET_FILE")

[ "$CURRENT_SIZE" -gt "$LAST_OFFSET" ] || exit 0

NEW_EVENTS=$(tail -c +"$((LAST_OFFSET + 1))" "$EVENTS_FILE")
echo "$CURRENT_SIZE" > "$OFFSET_FILE"

[ -n "$NEW_EVENTS" ] || exit 0

FORMATTED=$(echo "$NEW_EVENTS" | jq -rs '
  group_by(.feature + ":" + .event) | map(last) | sort_by(.ts) |
  if length == 0 then halt_error(1) else . end |
  "--- Fleet Events (\(length) new) ---\n" +
  (map(
    if .event == "pr_created" then "  \(.feature): PR created \(.url // "")"
    elif .event == "pushed" then "  \(.feature): pushed \(.branch // "")"
    elif .event == "context_warning" then "  \(.feature): context compacting â€” may lose coherence"
    else "  \(.feature): \(.event)"
    end
  ) | join("\n")) +
  "\n--- End Fleet Events ---"' 2>/dev/null)

[ -n "$FORMATTED" ] || exit 0

echo ""
echo "$FORMATTED"
echo ""
