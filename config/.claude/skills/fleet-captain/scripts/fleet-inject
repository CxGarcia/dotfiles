#!/usr/bin/env bash
# fleet-inject — Inject unread fleet events into captain's context
# Configured as a UserPromptSubmit hook
# Reads events.jsonl from last byte offset, deduplicates, outputs summary

EVENTS_FILE="$HOME/.claude/fleet/events.jsonl"
OFFSET_FILE="$HOME/.claude/fleet/.events_offset"

[ -f "$EVENTS_FILE" ] || exit 0

CURRENT_SIZE=$(wc -c < "$EVENTS_FILE" | tr -d ' ')
LAST_OFFSET=0
[ -f "$OFFSET_FILE" ] && LAST_OFFSET=$(cat "$OFFSET_FILE")

[ "$CURRENT_SIZE" -le "$LAST_OFFSET" ] && exit 0

NEW_EVENTS=$(tail -c +"$((LAST_OFFSET + 1))" "$EVENTS_FILE")
[ -z "$NEW_EVENTS" ] && exit 0

echo "$CURRENT_SIZE" > "$OFFSET_FILE"

# Deduplicate: keep only the latest event per feature+event_type
DEDUPED=$(echo "$NEW_EVENTS" | jq -s '
  group_by(.feature + ":" + .event)
  | map(last)
  | sort_by(.ts)
' 2>/dev/null)

[ -z "$DEDUPED" ] || [ "$DEDUPED" = "[]" ] && exit 0

COUNT=$(echo "$DEDUPED" | jq 'length')
[ "$COUNT" -eq 0 ] && exit 0

echo ""
echo "--- Fleet Events ($COUNT new) ---"
echo "$DEDUPED" | jq -r '.[] |
  if .event == "pr_created" then "  \(.feature): PR created \(.url // "")"
  elif .event == "pushed" then "  \(.feature): pushed \(.branch // "")"
  elif .event == "idle" then "  \(.feature): idle (finished current work)"
  elif .event == "needs_input" then "  \(.feature): NEEDS INPUT — user should jump in"
  elif .event == "context_warning" then "  \(.feature): context compacting — may lose coherence"
  else "  \(.feature): \(.event)"
  end'
echo "--- End Fleet Events ---"
echo ""

exit 0
