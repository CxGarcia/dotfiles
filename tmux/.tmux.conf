# ============================================================================
# Terminal & Color Support
# ============================================================================
set -as terminal-features ",xterm-256color:RGB"
set -g default-terminal "tmux-256color"

set -as terminal-features 'xterm*:extkeys'
set -as terminal-features ',*:usstyle'
set -g focus-events on
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'
set -g set-clipboard on

# ============================================================================
# Extended Keyboard Protocol
# ============================================================================

set -s extended-keys on
set -s extended-keys-format xterm

# ============================================================================
# General Settings
# ============================================================================

unbind C-b
set -g prefix M-Space
bind M-Space send-prefix

set -g mouse on
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -g history-limit 50000
set -sg escape-time 10
set -g display-time 4000
setw -g aggressive-resize on
set -g set-titles on
set -g set-titles-string '#S: #W'

# ============================================================================
# Key Bindings
# ============================================================================

# Reload config
bind r source-file ~/.tmux.conf \; display "Config reloaded!"

# Session switcher
bind -n M-s display-popup -E -w 60% -h 60% -b none "sesh connect \"$(sesh list | fzf --border=rounded --border-label=' Sessions ' --prompt='❯ ' --pointer='▶' --color=bg+:#252c33,bg:#252c33,spinner:#9ccfd8,hl:#ebbcba --color=fg:#e0def4,header:#eb6f92,info:#c4a7e7,pointer:#9ccfd8 --color=marker:#eb6f92,fg+:#e0def4,prompt:#c4a7e7,hl+:#ebbcba --color=border:#6e6a86 --no-preview --bind='ctrl-d:execute(tmux kill-session -t {})+reload(sesh list)')\""

# Split panes
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind c new-window -c "#{pane_current_path}"
unbind '"'
unbind %

# Pane resizing
bind -n M-Left resize-pane -L 2
bind -n M-Right resize-pane -R 2
bind -n M-Up resize-pane -U 2
bind -n M-Down resize-pane -D 2

bind -n M-o select-pane -t :.+
bind -n M-z resize-pane -Z

# ============================================================================
# Theme: Rose Pine
# ============================================================================

set -g status off
rose_pine_muted="#6e6a86"
rose_pine_foam="#9ccfd8"
rose_pine_text="#e0def4"
custom_bg_highlight="#2d3843"

set -g pane-border-style "fg=${rose_pine_muted}"
set -g pane-active-border-style "fg=${rose_pine_foam}"
set -g message-style "bg=${custom_bg_highlight},fg=${rose_pine_text}"
set -g message-command-style "bg=${custom_bg_highlight},fg=${rose_pine_text}"
setw -g mode-style "bg=${custom_bg_highlight},fg=${rose_pine_text}"

# ============================================================================
# Copy Mode
# ============================================================================

setw -g mode-keys vi
bind [ copy-mode
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-selection-and-cancel

# ============================================================================
# Tmux Plugin Manager (TPM)
# ============================================================================

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @yank_selection_mouse 'clipboard'
set -g @yank_action 'copy-pipe'

# ============================================================================
# Initialize TPM
# ============================================================================

if "test ! -d ~/.tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins'"

run '~/.tmux/plugins/tpm/tpm'
